<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Register | UniLifeTracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gradient-to-b from-indigo-50 to-pink-100 min-h-screen">
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    <div class="flex flex-col items-center justify-center min-h-[80vh]">
        <div class="bg-white shadow-lg rounded-xl p-8 w-full max-w-sm">
            <h3 class="text-xl font-bold text-center text-pink-700 mb-4">Create Your Account</h3>
            <form id="registerForm" autocomplete="off">
                <input type="text" id="name" placeholder="Full Name" required minlength="2" class="w-full mb-3 px-3 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-pink-300" />
                <div id="nameError" class="error-message text-sm text-red-500 mb-2"></div>
                <input type="text" id="username" placeholder="Username" required minlength="3" maxlength="30" pattern="[a-zA-Z0-9_]+" class="w-full mb-3 px-3 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-pink-300" />
                <div id="usernameError" class="error-message text-sm text-red-500 mb-2"></div>
                <input type="email" id="email" placeholder="Email" required class="w-full mb-3 px-3 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-pink-300" />
                <div id="emailError" class="error-message text-sm text-red-500 mb-2"></div>
                <input type="password" id="password" placeholder="Password" required class="w-full mb-3 px-3 py-2 rounded border focus:outline-none focus:ring-2 focus:ring-pink-300" />
                <div id="passwordHelp" class="text-xs text-gray-500 mb-1">At least 8 characters, including uppercase, lowercase, number, and symbol.</div>
                <div id="passwordError" class="error-message text-sm text-red-500 mb-2"></div>
                <button type="submit" class="w-full bg-pink-500 hover:bg-pink-700 text-white font-bold py-2 rounded-lg transition">Register</button>
            </form>
            <div id="registerMessage" class="mt-3 text-center"></div>
            <div class="text-center mt-4">
                <span class="text-sm text-slate-700">Already have an account?</span>
                <a href="/login" class="text-blue-600 underline ml-1">Log in</a>
            </div>
            <div class="text-center mt-1">
                <a href="/" class="text-pink-400 underline text-xs">← Back to Home</a>
            </div>
        </div>
    </div>

<script>
function passwordStrong(password) {
    return password.length >= 8 &&
           /[a-z]/.test(password) &&
           /[A-Z]/.test(password) &&
           /[0-9]/.test(password) &&
           /[^a-zA-Z0-9]/.test(password);
}

document.getElementById("registerForm").addEventListener("submit", function(e) {
    e.preventDefault();

    // Limpia errores previos
    document.getElementById("nameError").innerText = "";
    document.getElementById("usernameError").innerText = "";
    document.getElementById("emailError").innerText = "";
    document.getElementById("passwordError").innerText = "";
    document.getElementById("registerMessage").innerText = "";

    let valid = true;
    const name = document.getElementById("name").value.trim();
    const username = document.getElementById("username").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    // Validación nombre
    if (name.length < 2) {
        document.getElementById("nameError").innerText = "Name is too short.";
        valid = false;
    }
    // Validación username
    if (username.length < 3 || !/^[a-zA-Z0-9_]+$/.test(username)) {
        document.getElementById("usernameError").innerText = "Minimum 3 characters (letters, numbers, and _ only).";
        valid = false;
    }
    // Validación email
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
        document.getElementById("emailError").innerText = "Invalid email.";
        valid = false;
    }
    // Validación contraseña fuerte
    if (!passwordStrong(password)) {
        document.getElementById("passwordError").innerText = "Password must be at least 8 characters long, include an uppercase letter, a lowercase letter, a number, and a symbol.";
        valid = false;
    }

    if (!valid) return;

    const data = { name, username, email, password };

    fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(async resp => {
        const res = await resp.json();
        if (resp.ok) {
            document.getElementById("registerMessage").innerText = res.message || "Registration successful! You can log in.";
            document.getElementById("registerMessage").classList.remove("text-danger");
            document.getElementById("registerMessage").classList.add("success-message");
            document.getElementById("registerForm").reset();
        } else {
            document.getElementById("registerMessage").innerText = res.message || "Error during registration";
            document.getElementById("registerMessage").classList.remove("success-message");
            document.getElementById("registerMessage").classList.add("text-danger");
        }
    })
    .catch(() => {
        document.getElementById("registerMessage").innerText = "Error during registration";
        document.getElementById("registerMessage").classList.remove("success-message");
        document.getElementById("registerMessage").classList.add("text-danger");
    });
});
</script>
</body>
</html>
