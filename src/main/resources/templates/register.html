<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Register | UniLifeTracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    
    <style>
        .error-message { color: #dc3545; font-size: 0.95em; }
        .success-message { color: #198754; }
    </style>
</head>
<body>
    <div th:replace="~{fragments/navbar :: navbar}"></div>
    <div class="container mt-5" style="max-width: 400px;">
        <h3 class="mb-4 text-center">Create Account</h3>
        <form id="registerForm" autocomplete="off">
            <!-- Full Name -->
            <div class="mb-3">
                <label for="name" class="form-label">Full Name</label>
                <input type="text" class="form-control" id="name" required minlength="2">
                <div id="nameError" class="error-message"></div>
            </div>
            <!-- Username -->
            <div class="mb-3">
                <label for="username" class="form-label">Username</label>
                <input type="text" class="form-control" id="username" required minlength="3" maxlength="30" pattern="[a-zA-Z0-9_]+">
                <div id="usernameError" class="error-message"></div>
            </div>
            <!-- Email -->
            <div class="mb-3">
                <label for="email" class="form-label">Email</label>
                <input type="email" class="form-control" id="email" required>
                <div id="emailError" class="error-message"></div>
            </div>
            <!-- Password -->
            <div class="mb-3">
                <label for="password" class="form-label">Password</label>
                <input type="password" class="form-control" id="password" required>
                <div id="passwordHelp" class="form-text">
                  At least 8 characters, including uppercase, lowercase, number, and symbol.
                </div>
                <div id="passwordError" class="error-message"></div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Register</button>
        </form>
        <div id="registerMessage" class="mt-3 text-center"></div>
    </div>

<script>
function passwordStrong(password) {
    return password.length >= 8 &&
           /[a-z]/.test(password) &&
           /[A-Z]/.test(password) &&
           /[0-9]/.test(password) &&
           /[^a-zA-Z0-9]/.test(password);
}

document.getElementById("registerForm").addEventListener("submit", function(e) {
    e.preventDefault();

    // Limpia errores previos
    document.getElementById("nameError").innerText = "";
    document.getElementById("usernameError").innerText = "";
    document.getElementById("emailError").innerText = "";
    document.getElementById("passwordError").innerText = "";
    document.getElementById("registerMessage").innerText = "";

    let valid = true;
    const name = document.getElementById("name").value.trim();
    const username = document.getElementById("username").value.trim();
    const email = document.getElementById("email").value.trim();
    const password = document.getElementById("password").value;

    // Validación nombre
    if (name.length < 2) {
        document.getElementById("nameError").innerText = "Name is too short.";
        valid = false;
    }
    // Validación username
    if (username.length < 3 || !/^[a-zA-Z0-9_]+$/.test(username)) {
        document.getElementById("usernameError").innerText = "Minimum 3 characters (letters, numbers, and _ only).";
        valid = false;
    }
    // Validación email
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(email)) {
        document.getElementById("emailError").innerText = "Invalid email.";
        valid = false;
    }
    // Validación contraseña fuerte
    if (!passwordStrong(password)) {
        document.getElementById("passwordError").innerText = "Password must be at least 8 characters long, include an uppercase letter, a lowercase letter, a number, and a symbol.";
        valid = false;
    }

    if (!valid) return;

    const data = { name, username, email, password };

    fetch("/api/auth/register", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(data)
    })
    .then(async resp => {
        const res = await resp.json();
        if (resp.ok) {
            document.getElementById("registerMessage").innerText = res.message || "Registration successful! You can log in.";
            document.getElementById("registerMessage").classList.remove("text-danger");
            document.getElementById("registerMessage").classList.add("success-message");
            document.getElementById("registerForm").reset();
        } else {
            document.getElementById("registerMessage").innerText = res.message || "Error during registration";
            document.getElementById("registerMessage").classList.remove("success-message");
            document.getElementById("registerMessage").classList.add("text-danger");
        }
    })
    .catch(() => {
        document.getElementById("registerMessage").innerText = "Error during registration";
        document.getElementById("registerMessage").classList.remove("success-message");
        document.getElementById("registerMessage").classList.add("text-danger");
    });
});
</script>
</body>
</html>
