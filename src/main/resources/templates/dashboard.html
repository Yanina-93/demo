<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Dashboard | UniLifeTracker</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-green-50 min-h-screen flex flex-col">
    <!-- Navbar -->
    <div th:replace="~{fragments/navbar :: navbar}"></div>

    <main class="max-w-6xl mx-auto w-full py-8 flex-1 flex flex-col gap-8">

        <!-- 1. Tabla resumen de incomes y expenses -->
        <section class="bg-white rounded-xl shadow-md p-6">
            <h2 class="text-xl font-bold text-sky-700 mb-4">
                Welcome back <span th:text="${name}">User</span>
            </h2>
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200 text-sm">
                    <thead class="bg-sky-50">
                        <tr>
                            <th class="px-4 py-2 text-left font-semibold">Type</th>
                            <th class="px-4 py-2 text-left font-semibold">Description</th>
                            <th class="px-4 py-2 text-left font-semibold">Amount (€)</th>
                            <th class="px-4 py-2 text-left font-semibold">Date</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-100">
                        <!-- List incomes -->
                        <tr th:each="inc : ${incomes}">
                            <td class="px-4 py-2 text-green-700 font-medium">Income</td>
                            <td class="px-4 py-2" th:text="${inc.description}"></td>
                            <td class="px-4 py-2" th:text="${inc.amount}"></td>
                            <td class="px-4 py-2" th:text="${inc.date}"></td>
</td></td>
                        </tr>
                        <!-- List expenses -->
                        <tr th:each="exp : ${expenses}">
                            <td class="px-4 py-2 text-pink-700 font-medium">Expense</td>
                            <td class="px-4 py-2" th:text="${exp.description}"></td>
                            <td class="px-4 py-2" th:text="${exp.amount}"></td>
                            <td class="px-4 py-2" th:text="${exp.date}"></td>
</td></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div class="flex flex-col md:flex-row gap-4 mt-6 items-center justify-between">
                <div class="flex gap-4 text-lg">
                    <span class="font-semibold text-sky-800">Wallet: </span>
                    <span class="font-bold text-green-600" th:text="${saldo}">0</span> €
                </div>
                <div class="flex gap-4">
                    <a th:href="@{/incomes}" class="bg-green-200 hover:bg-green-300 text-green-800 font-semibold px-4 py-2 rounded-lg transition">Add income</a>
                    <a th:href="@{/expenses}" class="bg-pink-200 hover:bg-pink-300 text-pink-800 font-semibold px-4 py-2 rounded-lg transition">Add expense</a>
                    <a th:href="@{/calendar}" class="bg-sky-200 hover:bg-sky-300 text-purple-800 font-semibold px-4 py-2 rounded-lg transition">Go to calendar</a>
                    <a href="/dashboard/download-summary" class="bg-sky-500 text-blue-500 font-bold rounded-md py-2 px-6 hover:bg-blue-600 transition">Download Summary as Excel</a>
                </div>
                
            </div>
            
        </section>

        <!-- 2. Gráfico pastel de distribución por actividad -->
        <section class="bg-white rounded-xl shadow-md p-6 flex flex-col items-center w-70">
            <h3 class="text-lg font-semibold text-sky-700 mb-2">Time Distribution by Activity</h3>
            <canvas id="pieChart" width="500" height="500"></canvas>
        </section>

        <!-- 3. Próximos eventos -->
        <section class="bg-white rounded-xl shadow-md p-6">
            <h3 class="text-lg font-semibold text-sky-700 mb-3">Upcoming Events</h3>
            <ul class="divide-y divide-gray-100">
                <li th:each="event : ${upcomingEvents}" class="py-3 flex items-center gap-6">
                    <span class="font-bold text-sky-700" th:text="${event.title}">Event</span>
                    <span class="text-sm text-gray-600 px-4 py-2" th:text="${event.start}"></span>

                    <span class="bg-sky-100 text-sky-800 px-3 py-1 rounded-full text-xs" th:text="${event.type}"></span>
                </li>
                <li th:if="${#lists.isEmpty(upcomingEvents)}" class="text-gray-400 text-center py-4">
                    No upcoming events!
                </li>
            </ul>
        </section>

        <!-- 4. APIs Externas y Quotes -->
        <section class="bg-white rounded-xl shadow-md p-6 flex flex-col gap-4 items-center">
            <div class="flex flex-wrap gap-4 mb-2">
                <button onclick="showQuotePopup()" class="bg-purple-400 hover:bg-purple-500 text-white font-bold rounded-md py-2 px-4 transition">Get Motivation</button>
                <button onclick="showCurrencyPopup()" class="bg-yellow-300 hover:bg-yellow-400 text-yellow-900 font-bold rounded-md py-2 px-4 transition">Check rate EUR/CLP</button>
            </div>
            <h3 class="text-lg font-semibold text-sky-700">My Motivational Quotes</h3>
            <div id="myQuotesContainer" class="w-full"></div>
            <button onclick="loadMyQuotes()" class="bg-sky-300 hover:bg-sky-400 text-sky-800 font-semibold px-4 py-2 rounded-lg transition">🔄 Reload Quotes</button>
        </section>
    </main>

    <!-- MOTIVATION POPUP -->
    <div id="quotePopup"
        style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:#fff; border-radius:18px; padding:28px 20px; min-width:290px; max-width:80vw; box-shadow:0 4px 32px #0003; text-align:center; position:relative;">
            <p id="quoteText" style="font-size:1.1rem; margin-bottom:20px;"></p>
            <button onclick="saveQuote()" style="margin: 0 6px; background:#4b9cff; color:#fff; border:none; padding:8px 20px; border-radius:7px; cursor:pointer;">Save Quote</button>
            <button onclick="closeQuotePopup()" style="margin: 0 6px; background:#ccc; color:#333; border:none; padding:8px 20px; border-radius:7px; cursor:pointer;">Close</button>
            <span id="saveStatus" style="display:block; margin-top:10px; color:green; font-size:0.96rem;"></span>
        </div>
    </div>

    <!-- CURRENCY POPUP -->
    <div id="currencyPopup" style="display:none; position:fixed; top:30%; left:50%; transform:translate(-50%,-50%); background:#fff; padding:30px; box-shadow:0 2px 18px #0002; border-radius:15px;">
        <h3> EUR/CLP</h3>
        <div id="currencyContent">Loading...</div>
        <button onclick="closeCurrencyPopup()">Close</button>
    </div>

    <!-- JS Chart y APIs -->
    <script th:inline="javascript">
        /*<![CDATA[*/
        // Chart.js - Pastel de actividades
        var pieLabels = /*[[${categoryDurations.keySet()}]]*/ [];
        var pieData = /*[[${categoryDurations.values()}]]*/ [];
        pieLabels = Array.from(pieLabels);
        pieData = Array.from(pieData);

        const ctx = document.getElementById('pieChart').getContext('2d');
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: pieLabels,
                datasets: [{
                    data: pieData,
                    backgroundColor: [
                        '#FF6384','#36A2EB','#FFCE56','#7FD674','#AF7AC5','#F1948A'
                    ],
                }]
            },
            options: {
                responsive: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                let total = context.dataset.data.reduce((a, b) => a + b, 0);
                                let value = context.parsed;
                                let percent = total > 0 ? (value / total * 100).toFixed(1) : 0;
                                return `${context.label}: ${value.toFixed(2)} hrs (${percent}%)`;
                            }
                        }
                    }
                }
            }
        });
        /*]]>*/
    </script>
    <script>
        // MOTIVATION QUOTES
        function showQuotePopup() {
            document.getElementById('saveStatus').innerText = '';
            document.getElementById('quoteText').innerText = 'Loading...';
            document.getElementById('quotePopup').style.display = 'flex';

            fetch('/api/motivation/random-quote')
                .then(res => res.text())
                .then(text => {
                    document.getElementById('quoteText').innerText = text;
                })
                .catch(() => {
                    document.getElementById('quoteText').innerText = "Couldn't load quote. Try again!";
                });
        }
        function closeQuotePopup() { document.getElementById('quotePopup').style.display = 'none'; }
        function saveQuote() {
            const quoteText = document.getElementById('quoteText').innerText;
            fetch('/api/quotes', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ text: quoteText })
            })
            .then(response => {
                if (response.ok) document.getElementById('saveStatus').innerText = 'Quote Saved!';
                else document.getElementById('saveStatus').innerText = 'Failed to save quote.';
                setTimeout(closeQuotePopup, 1500);
            })
            .catch(() => {
                document.getElementById('saveStatus').innerText = 'Error saving quote.';
            });
        }

        // MY QUOTES SECTION
        function loadMyQuotes() {
            fetch('/api/quotes/my')
                .then(res => res.json())
                .then(list => {
                    const cont = document.getElementById('myQuotesContainer');
                    if (!list.length) {
                        cont.innerHTML = "<p>No motivational quotes saved yet!</p>";
                        return;
                    }
                    cont.innerHTML = "<ul class='space-y-2'>" + 
                        list.map(q => `
                            <li class="flex items-center justify-between bg-sky-50 rounded px-4 py-2">
                                <span>${q.text}</span>
                                <button onclick="deleteQuote(${q.id})" class="text-red-600 hover:text-red-800 ml-2">🗑️</button>
                            </li>
                        `).join('') + "</ul>";
                });
        }
        function deleteQuote(id) {
            if (!confirm('Are you sure you want to delete this quote?')) return;
            fetch('/api/quotes/' + id, { method: 'DELETE' })
                .then(() => loadMyQuotes());
        }
        document.addEventListener('DOMContentLoaded', loadMyQuotes);

        // CURRENCY API
        function showCurrencyPopup() {
            document.getElementById('currencyContent').innerText = "Loading...";
            document.getElementById('currencyPopup').style.display = 'block';

            fetch('/api/currency/eur-clp')
            .then(res => res.json())
            .then(rate => {
                document.getElementById('currencyContent').innerHTML = `<b>1 EUR = ${rate} CLP</b>`;
            })
            .catch(() => {
                document.getElementById('currencyContent').innerText = "Unable to get rate.";
            });
        }
        function closeCurrencyPopup() { document.getElementById('currencyPopup').style.display = 'none'; }
    </script>
    <div th:replace="~{fragments/footer :: footer}"></div>
</body>
</html>
